<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Telugu Live TV Player</title>

<!-- Favicon -->
<link rel="icon" type="image/png" href="Logo.png">

<!-- HLS.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#0f0f0f;color:#fff;height:100vh;display:flex;flex-direction:column;}
header{background:#000;padding:10px;text-align:center;font-size:18px;font-weight:bold;display:flex;justify-content:space-between;align-items:center}
header img{width:200px;height:100px;object-fit:contain}
video{width:100%;background:#000;flex:1;object-fit:contain;display:block}
.controls{display:flex;gap:6px;padding:8px}
input,select{flex:1;padding:8px;border-radius:5px;border:none}
.container{display:flex;flex-direction:column;flex:1;overflow:hidden}
#channels{overflow-y:auto;scroll-behavior:smooth;padding-bottom:20px;flex:1}
.group{background:#222;padding:8px;font-weight:bold;cursor:pointer;user-select:none;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center}
.group:hover{background:#333}
.channel{padding:8px 12px;border-bottom:1px solid #333;display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer}
.channel:hover,.channel:focus{background:#444;outline:none}
.logo{width:40px;height:40px;border-radius:6px;object-fit:contain}
.star{color:gold;font-size:18px;cursor:pointer}
.collapsed .channel{display:none}
@media(min-width:768px){.container{flex-direction:row}video{width:70%;height:100%;flex:1}#channels{width:30%;max-height:100%}}
.logout{background:#c00;color:#fff;padding:5px 10px;border-radius:5px;border:none;cursor:pointer}
.logout:hover{background:#900}
</style>
</head>
<body>

<header>
<img src="Logo.png" alt="PR DigiTV">
<button class="logout" onclick="logout()">Logout</button>
</header>

<div class="controls">
<input id="search" placeholder="Search channel">
<select id="filter">
  <option value="all">All</option>
  <option value="fav">❤️ Favorites</option>
</select>
</div>

<div class="container">
<video id="player" controls autoplay></video>
<div id="channels"></div>
</div>

<script>
/* ================== AUTH CHECK ================== */
const userEmail = localStorage.getItem("user");
if(!userEmail) window.location.href="index.html";

function logout(){
  localStorage.removeItem("user");
  window.location.href="index.html";
}

/* ================== AUTO LOGOUT ================== */
let logoutTimer;
function resetTimer(){
  clearTimeout(logoutTimer);
  logoutTimer=setTimeout(()=>{logout();alert("Logged out due to inactivity");},10*60*1000);
}
document.onmousemove=resetTimer;
document.onkeypress=resetTimer;
document.ontouchstart=resetTimer;
resetTimer();
window.addEventListener("beforeunload",()=>{logout();});

/* ================== PLAYER & CHANNEL SETUP ================== */
const video=document.getElementById("player");
const list=document.getElementById("channels");
const search=document.getElementById("search");
const filter=document.getElementById("filter");

let channels=[];
let fav=JSON.parse(localStorage.getItem("fav_"+userEmail))||[];
let defaultLogo="https://via.placeholder.com/40";

/* ================== FULL M3U DATA ================== */
const m3uData = `...`; // Keep your full M3U data here

/* ================== PARSE M3U ================== */
function parse(){
  let lines=m3uData.split("\n");
  for(let i=0;i<lines.length;i++){
    if(lines[i].startsWith("#EXTINF")){
      let name=lines[i].split(",")[1];
      let group=(lines[i].match(/group-title="([^"]+)"/)||[])[1]||"Other";
      channels.push({name,group,url:lines[i+1]});
    }
  }
  populateFilter();
  render();
  let last = localStorage.getItem("last_"+userEmail);
  if(last) play(last,true);
}

/* ================== FILTER ================== */
function populateFilter(){
  let groups=[...new Set(channels.map(c=>c.group))];
  groups.forEach(g=>{
    let opt=document.createElement("option");
    opt.value=g; opt.textContent=g;
    filter.appendChild(opt);
  });
}

/* ================== PLAYER ================== */
function play(url,resume=false){
  localStorage.setItem("last_"+userEmail,url);
  if(video.canPlayType("application/vnd.apple.mpegurl")) video.src=url;
  else if(Hls.isSupported()){let hls=new Hls(); hls.loadSource(url); hls.attachMedia(video);}
  video.play();
  highlightCurrent(url,resume);
}

/* ================== HIGHLIGHT & SCROLL ================== */
function highlightCurrent(url,resume=false){
  document.querySelectorAll(".channel").forEach(ch=>{
    if(ch.dataset.url===url){
      ch.style.background="#555";
      if(resume) ch.scrollIntoView({behavior:"smooth",block:"center"});
    } else ch.style.background="";
  });
}

/* ================== TOGGLE FAVORITE ================== */
function toggle(n){
  fav=fav.includes(n)?fav.filter(x=>x!==n):[...fav,n];
  localStorage.setItem("fav_"+userEmail,JSON.stringify(fav));
  render();
}

/* ================== RENDER CHANNELS ================== */
function render(){
  list.innerHTML="";
  let cg="";
  let filtered = channels.filter(c=>{
    if(search.value.trim()!=="") return c.name.toLowerCase().includes(search.value.toLowerCase());
    if(filter.value==="all") return true;
    if(filter.value==="fav") return fav.includes(c.name);
    return c.group===filter.value;
  });

  filtered.forEach(c=>{
    if(c.group!==cg){
      cg=c.group;
      let g=document.createElement("div");
      g.className="group collapsed";
      g.textContent=c.group;
      g.onclick=()=>g.classList.toggle("collapsed");
      list.appendChild(g);
    }
    let d=document.createElement("div");
    d.className="channel";
    d.dataset.url=c.url;
    d.tabIndex=0;
    d.onkeydown=e=>{if(e.key==="Enter") play(c.url)};
    d.innerHTML=`<div style="display:flex;align-items:center;gap:10px" onclick="play('${c.url}')">
<img src="${defaultLogo}" class="logo"><span>${c.name}</span></div>
<span class="star" onclick="toggle('${c.name}')">${fav.includes(c.name)?'★':'☆'}</span>`;
    list.appendChild(d);
  });
}

/* ================== SEARCH/FILTER EVENTS ================== */
search.addEventListener("input",render);

// Clear search when category changes & render
filter.addEventListener("change",()=>{
  search.value="";
  render();
});

/* ================== AUTO NEXT IN CATEGORY ================== */
video.addEventListener("ended",()=>{
  let current=localStorage.getItem("last_"+userEmail);
  if(!current) return;
  let currentChannel=channels.find(c=>c.url===current);
  if(!currentChannel) return;
  let categoryChannels=channels.filter(c=>c.group===currentChannel.group);
  let index=categoryChannels.findIndex(c=>c.url===current);
  let next=index+1<categoryChannels.length ? categoryChannels[index+1].url : categoryChannels[0].url;
  play(next);
});

/* ================== INIT ================== */
parse();
</script>
</body>
</html>
